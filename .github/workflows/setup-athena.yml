name: Setup Athena Database

on:
  push:
    branches:
      - main
    paths:
      - 'config/athena-ddl.sql'
      - '.github/workflows/setup-athena.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ATHENA_DATABASE: wistia_analytics
  ATHENA_RESULTS_BUCKET: wistia-analytics-athena-results

jobs:
  setup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install PyAthena
        run: |
          pip install pyathena

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check Athena results bucket exists
        run: |
          aws s3api head-bucket --bucket ${{ env.ATHENA_RESULTS_BUCKET }} || \
            (echo "Creating Athena results bucket..." && \
            aws s3api create-bucket --bucket ${{ env.ATHENA_RESULTS_BUCKET }} --region ${{ env.AWS_REGION }})

      - name: Create Athena database and tables
        run: |
          python << 'EOF'
          from pyathena import connect
          import os
          
          # Read SQL file
          with open('config/athena-ddl.sql', 'r') as f:
              sql_commands = f.read().split(';')
          
          # Connect to Athena
          conn = connect(
              s3_output='s3://wistia-analytics-athena-results/',
              region_name='us-east-1'
          )
          cursor = conn.cursor()
          
          executed = 0
          for sql in sql_commands:
              sql = sql.strip()
              if sql and not sql.startswith('--'):
                  try:
                      print(f"Executing: {sql[:80]}...")
                      cursor.execute(sql)
                      executed += 1
                      print("✅ Success")
                  except Exception as e:
                      print(f"⚠️  {str(e)}")
          
          print(f"\n✅ Executed {executed} SQL statements")
          cursor.close()
          conn.close()
          EOF

      - name: Verify tables created
        run: |
          python << 'EOF'
          from pyathena import connect
          
          conn = connect(
              s3_output='s3://wistia-analytics-athena-results/',
              region_name='us-east-1'
          )
          cursor = conn.cursor()
          
          # List tables
          cursor.execute("SHOW TABLES IN wistia_analytics")
          tables = cursor.fetchall()
          
          print("Tables in wistia_analytics:")
          for table in tables:
              print(f"  - {table[0]}")
          
          cursor.close()
          conn.close()
          EOF

      - name: Notify on success
        if: success()
        run: |
          echo "✅ Athena database setup successful!"
          echo "Database: ${{ env.ATHENA_DATABASE }}"
          echo "Results bucket: ${{ env.ATHENA_RESULTS_BUCKET }}"

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Athena setup failed!"
          exit 1
